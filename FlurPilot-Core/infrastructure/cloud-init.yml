#cloud-config
timezone: Europe/Berlin

swap:
  filename: /swapfile
  size: "4G"
  maxsize: "4G"

users:
  - name: deployer
    groups: users, admin, docker
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      # Add your public SSH key here later or injection via Terraform var
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... REPLACE_ME_WITH_YOUR_PUBLIC_KEY

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose-v2
  - ufw
  - fail2ban
  - unattended-upgrades

runcmd:
  # Enable Docker
  - systemctl enable --now docker
  # Firewall Setup (UFW fallback)
  - ufw allow OpenSSH
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

# Volume Management
fs_setup:
  - label: flurpilot-data
    filesystem: ext4
    device: /dev/disk/by-id/scsi-0HC_Volume_flurpilot-data
    overwrite: false

mounts:
  - [ /dev/disk/by-id/scsi-0HC_Volume_flurpilot-data, /mnt/flurpilot-data, "ext4", "defaults,nofail,discard", "0", "2" ]
